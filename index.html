<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø§Ù„Ø°ÙƒÙŠ - Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg: #f0f8ff;
    --primary: #2563eb;
    --primary-dark: #1e40af;
    --secondary: #10b981;
    --accent: #f59e0b;
    --muted: #64748b;
    --card: #ffffff;
    --border: #e2e8f0;
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Cairo', sans-serif;
    background: var(--bg);
    color: #1e293b;
    line-height: 1.6;
    padding: 20px;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    overflow: hidden;
  }
  
  header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 24px;
    text-align: center;
  }
  
  header h1 {
    margin: 0;
    font-size: 1.8rem;
  }
  
  header .sub {
    opacity: 0.9;
    margin-top: 8px;
  }
  
  .section {
    padding: 24px;
  }
  
  .section-title {
    font-size: 1.4rem;
    margin-bottom: 20px;
    color: var(--primary);
    border-bottom: 2px solid var(--border);
    padding-bottom: 10px;
  }
  
  .grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
  }
  
  input[type="text"],
  input[type="number"],
  select,
  textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 1rem;
    font-family: 'Cairo', sans-serif;
  }
  
  button {
    padding: 12px 20px;
    border-radius: 10px;
    border: 0;
    background: var(--primary);
    color: white;
    cursor: pointer;
    font-family: 'Cairo', sans-serif;
    font-weight: 600;
    font-size: 1rem;
    margin: 5px;
  }
  
  button:hover {
    background: var(--primary-dark);
  }
  
  button.secondary {
    background: var(--secondary);
  }
  
  button.danger {
    background: var(--danger);
  }
  
  .small {
    font-size: 0.9rem;
    color: var(--muted);
  }
  
  .upload-box {
    border: 2px dashed #c7d2fe;
    padding: 20px;
    border-radius: 10px;
    background: #f8faff;
    text-align: center;
    margin: 10px 0;
  }
  
  .card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
    margin: 10px 0;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }
  
  .stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border-left: 4px solid var(--primary);
  }
  
  .stat-card h3 {
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 8px;
  }
  
  .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--primary);
  }
  
  .table-wrap {
    margin-top: 20px;
    overflow: auto;
    border-radius: 10px;
    border: 1px solid var(--border);
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
  }
  
  th, td {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border);
    text-align: center;
  }
  
  th {
    background: var(--primary);
    color: white;
    font-weight: 600;
  }
  
  tr:nth-child(even) {
    background: #f8fafc;
  }
  
  .report {
    background: #f8fafc;
    padding: 20px;
    border-radius: 10px;
    border-right: 4px solid var(--secondary);
    margin-top: 20px;
    white-space: pre-line;
    line-height: 1.8;
  }
  
  .controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 20px;
  }
  
  .no-print {
    display: inline-block;
  }
  
  .charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }
  
  .chart-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
  }
  
  .chart-title {
    font-size: 1.1rem;
    margin-bottom: 15px;
    text-align: center;
    color: var(--primary);
    font-weight: 600;
  }
  
  .message {
    padding: 12px 16px;
    border-radius: 8px;
    margin: 10px 0;
    font-weight: 500;
  }
  
  .message.success {
    background: #f0fdf4;
    color: #166534;
    border: 1px solid #bbf7d0;
  }
  
  .message.error {
    background: #fef2f2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }

  @media print {
    .no-print {
      display: none !important;
    }
    
    .container {
      box-shadow: none !important;
    }
    
    button {
      display: none !important;
    }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØµÙˆÙ„</h1>
    <div class="sub">Ø¥Ø¹Ø¯Ø§Ø¯: <strong>Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ</strong> â€” <strong>Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø±Ø§Ø²ÙŠ</strong></div>
  </header>

  <!-- INPUT SECTION -->
  <div class="section no-print" id="inputSection">
    <h3 class="section-title">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
    
    <div class="grid">
      <div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</label>
        <input id="teacherName" type="text" value="Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ" />
      </div>
      <div>
        <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
        <input id="subject" type="text" value="Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª" />
      </div>
      <div>
        <label>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</label>
        <input id="totalGrade" type="number" value="100" min="1" />
      </div>
    </div>

    <div style="margin-top:20px">
      <label>Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</label>
      <div style="display:flex; gap:10px; margin:10px 0;">
        <button onclick="showUpload()">ğŸ“ Ø±ÙØ¹ Ù…Ù„Ù Excel</button>
        <button onclick="showPaste()">ğŸ“‹ Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button onclick="showManual()">âœï¸ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</button>
      </div>
    </div>

    <!-- Ø·Ø±ÙŠÙ‚Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù -->
    <div id="uploadMethod" style="display:none">
      <div class="upload-box">
        <input type="file" id="excelFile" accept=".xlsx,.xls" style="margin-bottom:10px">
        <div class="small">Ø§Ø®ØªØ± Ù…Ù„Ù Excel ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ÙŠÙ†: Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„Ø¯Ø±Ø¬Ø©</div>
      </div>
    </div>

    <!-- Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„ØµÙ‚ -->
    <div id="pasteMethod" style="display:none">
      <textarea id="pasteData" rows="10" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ Ù…Ù† Excel...
Ù…Ø«Ø§Ù„:
Ø£Ø­Ù…Ø¯,85
Ù…Ø­Ù…Ø¯,92
ÙØ§Ø·Ù…Ø©,76
Ø³Ø§Ø±Ø©,88
Ø®Ø§Ù„Ø¯,65"></textarea>
      <div class="small">Ø§Ù†Ø³Ø® Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Excel (Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø«Ù… Ø§Ù„Ø¯Ø±Ø¬Ø§Øª)</div>
    </div>

    <!-- Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ -->
    <div id="manualMethod" style="display:none">
      <div id="manualInputs">
        <div class="manual-row">
          <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="student-name">
          <input type="number" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø©" class="student-grade" style="margin:0 10px">
          <button onclick="removeRow(this)" class="danger">âœ•</button>
        </div>
      </div>
      <button onclick="addRow()" class="secondary">+ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
    </div>

    <div style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap">
      <button onclick="analyzeData()" class="secondary">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <button onclick="resetData()" class="danger">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </div>

    <div id="message" style="margin-top:15px"></div>
  </div>

  <!-- RESULTS SECTION -->
  <div class="section" id="resultsSection" style="display:none">
    <h3 class="section-title">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3>
    <div id="summaryArea"></div>
    
    <div class="stats-grid" id="overallStats"></div>
    
    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-title">Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙÙŠ</div>
        <canvas id="categoryChart"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div>
        <canvas id="distributionChart"></canvas>
      </div>
    </div>
    
    <div id="perClassTables" style="margin-top:20px"></div>
    <div class="report" id="finalReport" style="margin-top:20px"></div>

    <div class="controls no-print">
      <button onclick="window.print()" class="secondary">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      <button onclick="exportToExcel()" class="secondary">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
      <button onclick="showInputSection()" class="danger">â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
    </div>
  </div>
</div>

<script>
// Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
function toFixedStr(n, d = 2) { return Number(n).toFixed(d) }
function mean(a) { return a.reduce((s, x) => s + x, 0) / a.length }
function median(a) { 
  const s = [...a].sort((x, y) => x - y); 
  const m = Math.floor(s.length / 2); 
  return s.length % 2 ? s[m] : (s[m - 1] + s[m]) / 2 
}
function stdPop(a) { 
  const m = mean(a); 
  return Math.sqrt(a.reduce((s, x) => s + Math.pow(x - m, 2), 0) / a.length) 
}
function classifyPercent(p) { 
  if (p >= 90) return 'Ù…Ù…ØªØ§Ø²'; 
  if (p >= 80) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹'; 
  if (p >= 70) return 'Ø¬ÙŠØ¯'; 
  if (p >= 60) return 'Ù…Ù‚Ø¨ÙˆÙ„'; 
  return 'Ø¶Ø¹ÙŠÙ' 
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø·Ø±Ù‚ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
function showUpload() {
  hideAllMethods();
  document.getElementById('uploadMethod').style.display = 'block';
}

function showPaste() {
  hideAllMethods();
  document.getElementById('pasteMethod').style.display = 'block';
}

function showManual() {
  hideAllMethods();
  document.getElementById('manualMethod').style.display = 'block';
}

function hideAllMethods() {
  document.getElementById('uploadMethod').style.display = 'none';
  document.getElementById('pasteMethod').style.display = 'none';
  document.getElementById('manualMethod').style.display = 'none';
}

// Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
function addRow() {
  const container = document.getElementById('manualInputs');
  const newRow = document.createElement('div');
  newRow.className = 'manual-row';
  newRow.innerHTML = `
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="student-name">
    <input type="number" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø©" class="student-grade" style="margin:0 10px">
    <button onclick="removeRow(this)" class="danger">âœ•</button>
  `;
  container.appendChild(newRow);
}

function removeRow(button) {
  button.parentElement.remove();
}

// ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
async function analyzeData() {
  try {
    let students = [];
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    if (document.getElementById('uploadMethod').style.display === 'block') {
      students = await getDataFromUpload();
    } else if (document.getElementById('pasteMethod').style.display === 'block') {
      students = getDataFromPaste();
    } else if (document.getElementById('manualMethod').style.display === 'block') {
      students = getDataFromManual();
    } else {
      showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
      return;
    }
    
    if (students.length === 0) {
      showMessage('Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©', 'error');
      return;
    }
    
    processAndDisplayResults(students);
    
  } catch (error) {
    showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ' + error.message, 'error');
  }
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
async function getDataFromUpload() {
  const fileInput = document.getElementById('excelFile');
  if (!fileInput.files[0]) {
    showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel', 'error');
    return [];
  }
  
  try {
    const arrayBuffer = await fileInput.files[0].arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
    
    const students = json.map((row, idx) => {
      const name = row['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'] || row['name'] || row['Name'] || row['student'] || Object.values(row)[0] || ('Ø·Ø§Ù„Ø¨ ' + (idx + 1));
      const rawGrade = row['Ø§Ù„Ø¯Ø±Ø¬Ø©'] || row['grade'] || row['Grade'] || Object.values(row)[1] || '';
      const grade = Number(rawGrade);
      
      return {
        name: String(name).trim(),
        grade: isNaN(grade) ? 0 : grade
      };
    }).filter(s => s.name && s.grade > 0);
    
    showMessage(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${students.length} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
    return students;
    
  } catch (error) {
    showMessage('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel', 'error');
    return [];
  }
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù„ØµÙ‚
function getDataFromPaste() {
  const pasteText = document.getElementById('pasteData').value.trim();
  if (!pasteText) {
    showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    return [];
  }
  
  const lines = pasteText.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const students = lines.map((line, idx) => {
    const parts = line.split(/[,;\t]/).map(p => p.trim());
    const name = parts[0] || 'Ø·Ø§Ù„Ø¨ ' + (idx + 1);
    const grade = Number(parts[1]) || 0;
    
    return { name, grade };
  }).filter(s => s.name && s.grade > 0);
  
  showMessage(`ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${students.length} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
  return students;
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
function getDataFromManual() {
  const nameInputs = document.querySelectorAll('.student-name');
  const gradeInputs = document.querySelectorAll('.student-grade');
  
  const students = [];
  for (let i = 0; i < nameInputs.length; i++) {
    const name = nameInputs[i].value.trim();
    const grade = Number(gradeInputs[i].value);
    
    if (name && grade > 0) {
      students.push({ name, grade });
    }
  }
  
  if (students.length === 0) {
    showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨', 'error');
    return [];
  }
  
  showMessage(`ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ${students.length} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
  return students;
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
function processAndDisplayResults(students) {
  const teacher = document.getElementById('teacherName').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  const subject = document.getElementById('subject').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  const totalGrade = Number(document.getElementById('totalGrade').value) || 100;
  
  const grades = students.map(s => s.grade);
  const percents = grades.map(g => (g / totalGrade) * 100);
  
  const meanGrade = mean(grades);
  const meanPct = mean(percents);
  const medPct = median(percents);
  const sdPct = stdPop(percents);
  const maxGrade = Math.max(...grades);
  const minGrade = Math.min(...grades);
  
  // Ø§Ù„ØªØµÙ†ÙŠÙ
  const categories = { 'Ù…Ù…ØªØ§Ø²': [], 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹': [], 'Ø¬ÙŠØ¯': [], 'Ù…Ù‚Ø¨ÙˆÙ„': [], 'Ø¶Ø¹ÙŠÙ': [] };
  const processedStudents = students.map(student => {
    const pct = (student.grade / totalGrade) * 100;
    const category = classifyPercent(pct);
    categories[category].push(student);
    return { ...student, percent: pct, category };
  });
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  document.getElementById('inputSection').style.display = 'none';
  document.getElementById('resultsSection').style.display = 'block';
  
  // Ø§Ù„Ù…Ù„Ø®Øµ
  document.getElementById('summaryArea').innerHTML = `
    <div class="small">Ø§Ù„Ù…Ø¹Ù„Ù…: <strong>${teacher}</strong> â€” Ø§Ù„Ù…Ø§Ø¯Ø©: <strong>${subject}</strong> â€” Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: <strong>${students.length}</strong></div>
  `;
  
  // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  document.getElementById('overallStats').innerHTML = `
    <div class="stat-card">
      <h3>Ø§Ù„Ù…ØªÙˆØ³Ø·</h3>
      <div class="stat-value">${toFixedStr(meanPct, 1)}%</div>
      <div class="small">${toFixedStr(meanGrade, 1)} Ø¯Ø±Ø¬Ø©</div>
    </div>
    <div class="stat-card">
      <h3>Ø§Ù„ÙˆØ³ÙŠØ·</h3>
      <div class="stat-value">${toFixedStr(medPct, 1)}%</div>
    </div>
    <div class="stat-card">
      <h3>Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ</h3>
      <div class="stat-value">${toFixedStr(sdPct, 1)}%</div>
    </div>
    <div class="stat-card">
      <h3>Ø£Ø¹Ù„Ù‰/Ø£Ù‚Ù„ Ø¯Ø±Ø¬Ø©</h3>
      <div class="stat-value">${maxGrade}/${minGrade}</div>
    </div>
  `;
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
  createCharts(categories, grades);
  
  // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
  let tableHtml = `
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
            <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
            <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
            <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  processedStudents.forEach((student, index) => {
    tableHtml += `
      <tr>
        <td>${index + 1}</td>
        <td>${student.name}</td>
        <td>${student.grade}</td>
        <td>${toFixedStr(student.percent, 1)}%</td>
        <td>${student.category}</td>
      </tr>
    `;
  });
  
  tableHtml += `</tbody></table></div>`;
  document.getElementById('perClassTables').innerHTML = tableHtml;
  
  // Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
  const reportText = `
ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ
Ø§Ù„Ù…Ø§Ø¯Ø©: ${subject}
Ø§Ù„Ù…Ø¹Ù„Ù…: ${teacher}
Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: ${students.length}

Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:
â€¢ Ø§Ù„Ù…ØªÙˆØ³Ø·: ${toFixedStr(meanPct, 1)}%
â€¢ Ø§Ù„ÙˆØ³ÙŠØ·: ${toFixedStr(medPct, 1)}%
â€¢ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ: ${toFixedStr(sdPct, 1)}%
â€¢ Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©: ${maxGrade}
â€¢ Ø£Ù‚Ù„ Ø¯Ø±Ø¬Ø©: ${minGrade}

Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙÙŠ:
â€¢ Ù…Ù…ØªØ§Ø²: ${categories['Ù…Ù…ØªØ§Ø²'].length} Ø·Ø§Ù„Ø¨
â€¢ Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹: ${categories['Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹'].length} Ø·Ø§Ù„Ø¨
â€¢ Ø¬ÙŠØ¯: ${categories['Ø¬ÙŠØ¯'].length} Ø·Ø§Ù„Ø¨
â€¢ Ù…Ù‚Ø¨ÙˆÙ„: ${categories['Ù…Ù‚Ø¨ÙˆÙ„'].length} Ø·Ø§Ù„Ø¨
â€¢ Ø¶Ø¹ÙŠÙ: ${categories['Ø¶Ø¹ÙŠÙ'].length} Ø·Ø§Ù„Ø¨

${getAnalysisText(meanPct, sdPct, categories)}

ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString('ar-EG')}
  `;
  
  document.getElementById('finalReport').innerText = reportText;
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
function createCharts(categories, grades) {
  // Ù…Ø®Ø·Ø· Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
  const categoryCtx = document.getElementById('categoryChart').getContext('2d');
  new Chart(categoryCtx, {
    type: 'pie',
    data: {
      labels: ['Ù…Ù…ØªØ§Ø²', 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹', 'Ø¬ÙŠØ¯', 'Ù…Ù‚Ø¨ÙˆÙ„', 'Ø¶Ø¹ÙŠÙ'],
      datasets: [{
        data: [
          categories['Ù…Ù…ØªØ§Ø²'].length,
          categories['Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹'].length,
          categories['Ø¬ÙŠØ¯'].length,
          categories['Ù…Ù‚Ø¨ÙˆÙ„'].length,
          categories['Ø¶Ø¹ÙŠÙ'].length
        ],
        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#64748b']
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
  
  // Ù…Ø®Ø·Ø· ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
  const distributionCtx = document.getElementById('distributionChart').getContext('2d');
  const gradeRanges = ['0-49', '50-59', '60-69', '70-79', '80-89', '90-100'];
  const gradeCounts = [0, 0, 0, 0, 0, 0];
  
  grades.forEach(grade => {
    const percent = (grade / 100) * 100;
    if (percent >= 90) gradeCounts[5]++;
    else if (percent >= 80) gradeCounts[4]++;
    else if (percent >= 70) gradeCounts[3]++;
    else if (percent >= 60) gradeCounts[2]++;
    else if (percent >= 50) gradeCounts[1]++;
    else gradeCounts[0]++;
  });
  
  new Chart(distributionCtx, {
    type: 'bar',
    data: {
      labels: gradeRanges,
      datasets: [{
        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨',
        data: gradeCounts,
        backgroundColor: '#8b5cf6'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

// Ù†Øµ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ
function getAnalysisText(meanPct, sdPct, categories) {
  let analysis = '\nØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ:\n';
  
  if (meanPct >= 80) {
    analysis += 'â€¢ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø² Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…\n';
    analysis += 'â€¢ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¥Ø«Ø±Ø§Ø¡ ÙˆØ§Ù„ØªØ­Ø¯ÙŠ\n';
  } else if (meanPct >= 70) {
    analysis += 'â€¢ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯\n';
    analysis += 'â€¢ ÙŠØ­ØªØ§Ø¬ Ù„ØªØ¹Ø²ÙŠØ² Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©\n';
  } else if (meanPct >= 60) {
    analysis += 'â€¢ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ù‚Ø¨ÙˆÙ„\n';
    analysis += 'â€¢ ÙŠØ­ØªØ§Ø¬ Ù„Ø¯Ø¹Ù… Ø¥Ø¶Ø§ÙÙŠ ÙÙŠ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©\n';
  } else {
    analysis += 'â€¢ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙŠØ­ØªØ§Ø¬ Ù„ØªØ¯Ø®Ù„ Ø¹Ø§Ø¬Ù„\n';
    analysis += 'â€¢ ÙŠÙˆØµÙ‰ Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ¯Ø±ÙŠØ³ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©\n';
  }
  
  if (sdPct > 15) {
    analysis += 'â€¢ Ù‡Ù†Ø§Ùƒ ØªÙØ§ÙˆØª ÙƒØ¨ÙŠØ± ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø§Ø¨\n';
    analysis += 'â€¢ ÙŠÙˆØµÙ‰ Ø¨Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù…ØªÙ…Ø§ÙŠØ² Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª\n';
  } else if (sdPct > 8) {
    analysis += 'â€¢ Ù‡Ù†Ø§Ùƒ ØªÙØ§ÙˆØª Ù…ØªÙˆØ³Ø· ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª\n';
    analysis += 'â€¢ ÙŠÙ…ÙƒÙ† Ø¹Ù…Ù„ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ØªØ¹Ù„Ù… Ù…ØªØ¬Ø§Ù†Ø³Ø©\n';
  } else {
    analysis += 'â€¢ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ù…ØªÙ‚Ø§Ø±Ø¨Ø© Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø§Ø¨\n';
    analysis += 'â€¢ Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ\n';
  }
  
  return analysis;
}

// Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ù€ Excel
function exportToExcel() {
  const teacher = document.getElementById('teacherName').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  const subject = document.getElementById('subject').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  
  const wb = XLSX.utils.book_new();
  const wsData = [['Ø§Ù„Ø±Ù‚Ù…', 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„Ø¯Ø±Ø¬Ø©', 'Ø§Ù„Ù†Ø³Ø¨Ø©%', 'Ø§Ù„ØªØµÙ†ÙŠÙ']];
  
  const rows = document.querySelectorAll('#perClassTables table tbody tr');
  rows.forEach((row, index) => {
    const cells = row.querySelectorAll('td');
    wsData.push([
      index + 1,
      cells[1].textContent,
      cells[2].textContent,
      cells[3].textContent,
      cells[4].textContent
    ]);
  });
  
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ù†ØªØ§Ø¦Ø¬');
  XLSX.writeFile(wb, `Ù†ØªØ§Ø¦Ø¬_${subject}_${teacher}.xlsx`);
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
function showMessage(msg, type) {
  const el = document.getElementById('message');
  el.textContent = msg;
  el.className = `message ${type}`;
  setTimeout(() => {
    el.textContent = '';
    el.className = '';
  }, 5000);
}

function resetData() {
  if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
    document.getElementById('excelFile').value = '';
    document.getElementById('pasteData').value = '';
    document.getElementById('manualInputs').innerHTML = `
      <div class="manual-row">
        <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="student-name">
        <input type="number" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø©" class="student-grade" style="margin:0 10px">
        <button onclick="removeRow(this)" class="danger">âœ•</button>
      </div>
    `;
    hideAllMethods();
    showMessage('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
  }
}

function showInputSection() {
  document.getElementById('resultsSection').style.display = 'none';
  document.getElementById('inputSection').style.display = 'block';
}

// Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
document.addEventListener('DOMContentLoaded', function() {
  showMessage('Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„', 'success');
  addRow(); // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
});
</script>
</body>
</html>
