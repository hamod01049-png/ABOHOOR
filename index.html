<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø§Ù„Ø°ÙƒÙŠ - Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --bg: #f0f8ff;
    --primary: #2563eb;
    --primary-dark: #1e40af;
    --secondary: #10b981;
    --accent: #f59e0b;
    --muted: #64748b;
    --card: #ffffff;
    --border: #e2e8f0;
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --text: #1e293b;
    --text-light: #64748b;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Cairo', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    padding: 20px;
  }
  
  .container {
    max-width: 1400px;
    margin: 0 auto;
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    overflow: hidden;
  }
  
  header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 24px;
    text-align: center;
    position: relative;
  }
  
  header h1 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 700;
  }
  
  header .sub {
    opacity: 0.9;
    margin-top: 8px;
    font-size: 1.1rem;
  }
  
  .section {
    padding: 24px;
  }
  
  .section-title {
    font-size: 1.4rem;
    margin-bottom: 20px;
    color: var(--primary);
    border-bottom: 2px solid var(--border);
    padding-bottom: 10px;
    position: relative;
  }
  
  .section-title::after {
    content: "";
    position: absolute;
    bottom: -2px;
    right: 0;
    width: 80px;
    height: 2px;
    background: var(--secondary);
  }
  
  .grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--text);
  }
  
  input[type="text"],
  input[type="number"],
  select,
  textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 1rem;
    font-family: 'Cairo', sans-serif;
  }
  
  button {
    padding: 12px 20px;
    border-radius: 10px;
    border: 0;
    background: var(--primary);
    color: white;
    cursor: pointer;
    font-family: 'Cairo', sans-serif;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s;
  }
  
  button:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
  }
  
  button.secondary {
    background: var(--secondary);
  }
  
  button.danger {
    background: var(--danger);
  }
  
  .small {
    font-size: 0.9rem;
    color: var(--muted);
  }
  
  .upload-box {
    border: 2px dashed #c7d2fe;
    padding: 20px;
    border-radius: 10px;
    background: #f8faff;
    text-align: center;
  }
  
  .card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }
  
  .stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border-left: 4px solid var(--primary);
  }
  
  .stat-card h3 {
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 8px;
  }
  
  .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--primary);
  }
  
  .table-wrap {
    margin-top: 20px;
    overflow: auto;
    border-radius: 10px;
    border: 1px solid var(--border);
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
  }
  
  th, td {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border);
    text-align: center;
  }
  
  th {
    background: var(--primary);
    color: white;
    font-weight: 600;
  }
  
  tr:nth-child(even) {
    background: #f8fafc;
  }
  
  .report {
    background: #f8fafc;
    padding: 20px;
    border-radius: 10px;
    border-right: 4px solid var(--secondary);
    margin-top: 20px;
    white-space: pre-line;
    line-height: 1.8;
  }
  
  .controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 20px;
  }
  
  .no-print {
    display: inline-block;
  }
  
  .print-only {
    display: none;
  }
  
  .charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }
  
  .chart-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
  }
  
  .chart-title {
    font-size: 1.1rem;
    margin-bottom: 15px;
    text-align: center;
    color: var(--primary);
    font-weight: 600;
  }
  
  .message {
    padding: 12px 16px;
    border-radius: 8px;
    margin: 10px 0;
    font-weight: 500;
  }
  
  .message.success {
    background: #f0fdf4;
    color: #166534;
    border: 1px solid #bbf7d0;
  }
  
  .message.error {
    background: #fef2f2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }

  /* ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
  @media print {
    @page {
      margin: 1cm;
      size: A4;
    }
    
    body {
      background: white !important;
      color: black !important;
      font-size: 12pt;
      line-height: 1.4;
      padding: 0 !important;
    }
    
    .container {
      box-shadow: none !important;
      border-radius: 0 !important;
      max-width: 100% !important;
      margin: 0 !important;
    }
    
    .no-print {
      display: none !important;
    }
    
    .print-only {
      display: block !important;
    }
    
    header {
      background: #2563eb !important;
      color: white !important;
      padding: 20px !important;
      margin-bottom: 20px !important;
      -webkit-print-color-adjust: exact;
    }
    
    .section {
      padding: 15px !important;
      break-inside: avoid;
    }
    
    .section-title {
      color: #2563eb !important;
      border-bottom-color: #e2e8f0 !important;
      font-size: 16pt !important;
      margin-bottom: 15px !important;
    }
    
    .stats-grid {
      grid-template-columns: repeat(4, 1fr) !important;
      gap: 10px !important;
      margin: 15px 0 !important;
    }
    
    .stat-card {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
      border: 1px solid #e2e8f0 !important;
      padding: 15px !important;
    }
    
    .charts-container {
      grid-template-columns: 1fr 1fr !important;
      gap: 15px !important;
      margin: 20px 0 !important;
    }
    
    .chart-card {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
      border: 1px solid #e2e8f0 !important;
      break-inside: avoid;
    }
    
    .table-wrap {
      border: 1px solid #e2e8f0 !important;
      break-inside: avoid;
    }
    
    table {
      font-size: 10pt !important;
    }
    
    th {
      background: #2563eb !important;
      color: white !important;
      -webkit-print-color-adjust: exact;
    }
    
    .report {
      background: #f8fafc !important;
      border: 1px solid #e2e8f0 !important;
      break-inside: avoid;
    }
    
    button {
      display: none !important;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
    canvas {
      max-width: 100% !important;
      height: auto !important;
    }
    
    /* ØªØ±ÙˆÙŠØ³Ø© ÙˆØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© */
    .page-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #2563eb;
    }
    
    .page-footer {
      text-align: center;
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #e2e8f0;
      font-size: 10pt;
      color: #64748b;
    }
  }

  /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØµÙ…ÙŠÙ… Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
  @media (max-width: 768px) {
    .grid {
      grid-template-columns: 1fr;
    }
    
    .charts-container {
      grid-template-columns: 1fr;
    }
    
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .controls {
      flex-direction: column;
    }
    
    button {
      width: 100%;
    }
    
    @media print {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      .charts-container {
        grid-template-columns: 1fr !important;
      }
    }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØµÙˆÙ„</h1>
    <div class="sub">Ø¥Ø¹Ø¯Ø§Ø¯: <strong>Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ</strong> â€” <strong>Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø±Ø§Ø²ÙŠ</strong></div>
  </header>

  <!-- INPUT SECTION -->
  <div class="section no-print" id="inputSection">
    <h3 class="section-title">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
    <div class="grid">
      <div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</label>
        <input id="teacherName" type="text" value="Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ" />
      </div>
      <div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
        <input id="schoolName" type="text" value="Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø±Ø§Ø²ÙŠ" />
      </div>
      <div>
        <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
        <input id="subject" type="text" value="Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª" />
      </div>
      <div>
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
        <select id="testType">
          <option value="ØªÙƒÙˆÙŠÙ†ÙŠ">ØªÙƒÙˆÙŠÙ†ÙŠ</option>
          <option value="ØªÙ‚ÙˆÙŠÙ…ÙŠ">ØªÙ‚ÙˆÙŠÙ…ÙŠ</option>
        </select>
      </div>
      <div>
        <label>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</label>
        <input id="totalGrade" type="number" value="100" min="1" />
      </div>
      <div>
        <label>Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„</label>
        <select id="classCount">
          <option value="1">ÙØµÙ„ ÙˆØ§Ø­Ø¯</option>
          <option value="2">ÙØµÙ„Ø§Ù†</option>
          <option value="3">3 ÙØµÙˆÙ„</option>
        </select>
      </div>
    </div>

    <div style="margin-top:20px">
      <label>Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØµÙˆÙ„</label>
      <div id="filesArea"></div>
      <div class="small" style="margin-top:8px">
        Ø§Ø±ÙØ¹ Ù…Ù„Ù Excel Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¹Ù…ÙˆØ¯Ø§Ù†: Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ØŒ Ø§Ù„Ø¯Ø±Ø¬Ø©)
      </div>
    </div>

    <div style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap">
      <button id="analyzeBtn" class="secondary">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <button id="resetBtn" class="danger">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </div>

    <div id="message" style="margin-top:15px"></div>
  </div>

  <!-- RESULTS SECTION -->
  <div class="section" id="resultsSection" style="display:none">
    <!-- ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
    <div class="print-only page-header">
      <h1>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠ</h1>
      <div class="small">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø§Ù„Ø°ÙƒÙŠ - Ø¥Ø¹Ø¯Ø§Ø¯: Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ</div>
      <div class="small">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: <span id="reportDate"></span></div>
    </div>

    <h3 class="section-title">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3>
    <div id="summaryArea"></div>
    
    <div class="stats-grid" id="overallStats"></div>
    
    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-title">Ù…Ù‚Ø§Ø±Ù†Ø© Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„ÙØµÙˆÙ„</div>
        <canvas id="comparisonChart"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙÙŠ Ø§Ù„Ø¹Ø§Ù…</div>
        <canvas id="categoryChart"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div>
        <canvas id="distributionChart"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ</div>
        <canvas id="varianceChart"></canvas>
      </div>
    </div>
    
    <div id="perClassTables" style="margin-top:20px"></div>
    <div class="report" id="finalReport" style="margin-top:20px"></div>

    <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
    <div class="print-only page-footer">
      <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø§Ù„Ø°ÙƒÙŠ</p>
      <p>Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø±Ø§Ø²ÙŠ - Ù‚Ø³Ù… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„ØªØ±Ø¨ÙˆÙŠ</p>
    </div>

    <div class="controls no-print">
      <button class="secondary" id="downloadPdf">ğŸ“„ ØªÙ†Ø²ÙŠÙ„ PDF</button>
      <button class="secondary" id="downloadExcel">ğŸ“Š ØªÙ†Ø²ÙŠÙ„ Excel</button>
      <button class="secondary" id="printReport">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      <button id="backBtn">â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
    </div>
  </div>
</div>

<script>
// Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
function toFixedStr(n, d = 2) { return Number(n).toFixed(d) }
function mean(a) { return a.reduce((s, x) => s + x, 0) / a.length }
function median(a) { 
  const s = [...a].sort((x, y) => x - y); 
  const m = Math.floor(s.length / 2); 
  return s.length % 2 ? s[m] : (s[m - 1] + s[m]) / 2 
}
function stdPop(a) { 
  const m = mean(a); 
  return Math.sqrt(a.reduce((s, x) => s + Math.pow(x - m, 2), 0) / a.length) 
}
function classifyPercent(p) { 
  if (p >= 90) return 'Ù…Ù…ØªØ§Ø²'; 
  if (p >= 80) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹'; 
  if (p >= 70) return 'Ø¬ÙŠØ¯'; 
  if (p >= 60) return 'Ù…Ù‚Ø¨ÙˆÙ„'; 
  return 'Ø¶Ø¹ÙŠÙ' 
}
function escapeHtml(s) { 
  return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') 
}

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
const filesArea = document.getElementById('filesArea');
const classCountSelect = document.getElementById('classCount');
let classFileInputs = [];
let charts = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©

// Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function buildFileInputs() {
  filesArea.innerHTML = ''; 
  classFileInputs = []; 
  const count = Number(classCountSelect.value);
  
  for (let i = 1; i <= count; i++) {
    const div = document.createElement('div'); 
    div.style.marginTop = '12px';
    div.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
        <strong>ÙØµÙ„ ${i}</strong>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="upload-box">
          <input type="file" accept=".xlsx,.xls" class="classFileInput" data-class="${i}" style="margin-bottom:10px">
          <div class="small">Ø±ÙØ¹ Ù…Ù„Ù Excel</div>
        </div>
        <div>
          <textarea class="pasteArea" data-class-area="${i}" rows="5" placeholder="Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel Ù‡Ù†Ø§...
Ù…Ø«Ø§Ù„:
Ø£Ø­Ù…Ø¯,85
Ù…Ø­Ù…Ø¯,92
ÙØ§Ø·Ù…Ø©,76"></textarea>
        </div>
      </div>
    `;
    filesArea.appendChild(div);
    const fileInput = div.querySelector('.classFileInput');
    const pasteArea = div.querySelector('.pasteArea');
    classFileInputs.push({ fileInput, pasteArea, sheetJson: null, classIndex: i });
    fileInput.addEventListener('change', onClassFileChange);
  }
}

// Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel
async function onClassFileChange(e) {
  const input = e.target; 
  const idx = classFileInputs.findIndex(c => c.fileInput === input); 
  if (idx < 0) return;
  
  const file = input.files[0]; 
  if (!file) return;
  
  try {
    const arrayBuffer = await file.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
    
    classFileInputs[idx].sheetJson = json;
    showMessage(`ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù ÙØµÙ„ ${idx + 1} - ${json.length} Ø·Ø§Ù„Ø¨`, 'success');
  } catch (err) {
    showMessage('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel', 'error');
  }
}

// ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
document.getElementById('analyzeBtn').addEventListener('click', async () => {
  try {
    const teacher = document.getElementById('teacherName').value || '-';
    const school = document.getElementById('schoolName').value || '-';
    const subject = document.getElementById('subject').value || '-';
    const testType = document.getElementById('testType').value || '-';
    const totalGrade = Number(document.getElementById('totalGrade').value) || 100;
    const classCount = Number(classCountSelect.value);
    const classesData = [];
    
    for (let i = 0; i < classCount; i++) {
      const cfi = classFileInputs[i];
      let json = cfi.sheetJson;
      
      if ((!json || json.length === 0) && cfi.pasteArea.value.trim()) {
        json = parsePasted(cfi.pasteArea.value);
      }
      
      if (!json || json.length === 0) continue;
      
      const normalized = json.map((row, idx) => {
        const name = row['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'] || row['name'] || row['Name'] || row['student'] || Object.values(row)[0] || ('Ø·Ø§Ù„Ø¨ ' + (idx + 1));
        const rawGrade = row['Ø§Ù„Ø¯Ø±Ø¬Ø©'] || row['grade'] || row['Grade'] || Object.values(row)[1] || '';
        const grade = Number(rawGrade);
        
        return {
          name: String(name).trim(), 
          grade: isNaN(grade) ? null : grade
        };
      }).filter(r => r.name && r.grade !== null);
      
      if (normalized.length > 0) {
        classesData.push({
          label: `Ø§Ù„ÙØµÙ„ ${i + 1}`, 
          rows: normalized
        });
      }
    }
    
    if (classesData.length === 0) {
      showMessage('Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©', 'error');
      return;
    }
    
    const processedClasses = classesData.map(c => {
      const grades = c.rows.map(r => r.grade);
      const percents = grades.map(g => (g / totalGrade) * 100);
      
      const meanGrade = mean(grades);
      const meanPct = mean(percents);
      const medPct = median(percents);
      const sdPct = stdPop(percents);
      const maxGrade = Math.max(...grades);
      const minGrade = Math.min(...grades);
      
      const cats = { 'Ù…Ù…ØªØ§Ø²': [], 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹': [], 'Ø¬ÙŠØ¯': [], 'Ù…Ù‚Ø¨ÙˆÙ„': [], 'Ø¶Ø¹ÙŠÙ': [] };
      const rows = c.rows.map(r => {
        const pct = (r.grade / totalGrade) * 100;
        const cat = classifyPercent(pct);
        const out = { ...r, percent: pct, category: cat };
        cats[cat].push(out);
        return out;
      });
      
      return {
        label: c.label,
        rows,
        stats: {
          count: rows.length,
          meanGrade: toFixedStr(meanGrade, 2),
          meanPercent: toFixedStr(meanPct, 2),
          median: toFixedStr(medPct, 2),
          stdDev: toFixedStr(sdPct, 2),
          maxGrade,
          minGrade
        },
        cats
      };
    });

    renderResults({ teacher, school, subject, testType, totalGrade, processedClasses });
    showMessage('ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
  } catch (err) {
    showMessage('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„', 'error');
  }
});

// ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø³ÙˆØ®Ø©
function parsePasted(text) {
  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  return lines.map((l, idx) => {
    const parts = l.split(/[,;\t]/).map(p => p.trim());
    const obj = {};
    obj['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'] = parts[0] || 'Ø·Ø§Ù„Ø¨ ' + (idx + 1);
    obj['Ø§Ù„Ø¯Ø±Ø¬Ø©'] = parts[1] || '';
    return obj;
  });
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
function createCharts(processedClasses) {
  // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  charts.forEach(chart => chart.destroy());
  charts = [];
  
  const labels = processedClasses.map(c => c.label);
  const avgPercents = processedClasses.map(c => Number(c.stats.meanPercent));
  const stdDevs = processedClasses.map(c => Number(c.stats.stdDev));
  
  // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙÙŠ Ø§Ù„Ø¹Ø§Ù…
  const allCategories = ['Ù…Ù…ØªØ§Ø²', 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹', 'Ø¬ÙŠØ¯', 'Ù…Ù‚Ø¨ÙˆÙ„', 'Ø¶Ø¹ÙŠÙ'];
  const categoryCounts = allCategories.map(cat => 
    processedClasses.reduce((sum, pc) => sum + pc.cats[cat].length, 0)
  );
  
  // 1. Ù…Ø®Ø·Ø· Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª
  const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
  charts.push(new Chart(comparisonCtx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Ø§Ù„Ù…ØªÙˆØ³Ø· (%)',
        data: avgPercents,
        backgroundColor: '#3b82f6',
        borderColor: '#1d4ed8',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        },
        title: {
          display: true,
          text: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„ÙØµÙˆÙ„'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: 'Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©'
          }
        }
      }
    }
  }));
  
  // 2. Ù…Ø®Ø·Ø· Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙÙŠ
  const categoryCtx = document.getElementById('categoryChart').getContext('2d');
  charts.push(new Chart(categoryCtx, {
    type: 'pie',
    data: {
      labels: allCategories,
      datasets: [{
        data: categoryCounts,
        backgroundColor: [
          '#10b981', // Ù…Ù…ØªØ§Ø² - Ø£Ø®Ø¶Ø±
          '#3b82f6', // Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ - Ø£Ø²Ø±Ù‚
          '#f59e0b', // Ø¬ÙŠØ¯ - Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
          '#ef4444', // Ù…Ù‚Ø¨ÙˆÙ„ - Ø£Ø­Ù…Ø±
          '#64748b'  // Ø¶Ø¹ÙŠÙ - Ø±Ù…Ø§Ø¯ÙŠ
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  }));
  
  // 3. Ù…Ø®Ø·Ø· ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (Ù‡ÙŠØ³ØªÙˆØ¬Ø±Ø§Ù… Ù…Ø¨Ø³Ø·)
  const allGrades = processedClasses.flatMap(pc => pc.rows.map(r => r.grade));
  const gradeRanges = ['0-49', '50-59', '60-69', '70-79', '80-89', '90-100'];
  const gradeCounts = gradeRanges.map(() => 0);
  
  allGrades.forEach(grade => {
    if (grade >= 90) gradeCounts[5]++;
    else if (grade >= 80) gradeCounts[4]++;
    else if (grade >= 70) gradeCounts[3]++;
    else if (grade >= 60) gradeCounts[2]++;
    else if (grade >= 50) gradeCounts[1]++;
    else gradeCounts[0]++;
  });
  
  const distributionCtx = document.getElementById('distributionChart').getContext('2d');
  charts.push(new Chart(distributionCtx, {
    type: 'bar',
    data: {
      labels: gradeRanges,
      datasets: [{
        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨',
        data: gradeCounts,
        backgroundColor: '#8b5cf6'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Ù…Ø¯Ù‰ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª'
          }
        }
      }
    }
  }));
  
  // 4. Ù…Ø®Ø·Ø· Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ
  const varianceCtx = document.getElementById('varianceChart').getContext('2d');
  charts.push(new Chart(varianceCtx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ',
        data: stdDevs,
        borderColor: '#ef4444',
        backgroundColor: 'rgba(239, 68, 68, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ'
          }
        }
      }
    }
  }));
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
function renderResults(context) {
  document.getElementById('inputSection').style.display = 'none';
  document.getElementById('resultsSection').style.display = 'block';
  
  // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±
  document.getElementById('reportDate').textContent = new Date().toLocaleDateString('ar-EG');
  
  const { teacher, school, subject, testType, totalGrade, processedClasses } = context;
  
  document.getElementById('summaryArea').innerHTML = `
    <div class="small">Ø§Ù„Ù…Ø¹Ù„Ù…: <strong>${escapeHtml(teacher)}</strong> â€” Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: <strong>${escapeHtml(school)}</strong> â€” Ø§Ù„Ù…Ø§Ø¯Ø©: <strong>${escapeHtml(subject)}</strong></div>
  `;

  // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  const statsHTML = processedClasses.map(c => `
    <div class="stat-card">
      <h3>${c.label}</h3>
      <div class="stat-value">${c.stats.meanPercent}%</div>
      <div class="small">${c.stats.count} Ø·Ø§Ù„Ø¨</div>
      <div class="small">Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù: ${c.stats.stdDev}%</div>
    </div>
  `).join('');
  
  document.getElementById('overallStats').innerHTML = statsHTML;

  // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
  createCharts(processedClasses);

  // Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
  const perClassDiv = document.getElementById('perClassTables');
  perClassDiv.innerHTML = '';
  
  processedClasses.forEach(c => {
    const cards = `
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
        <div class="card"><h4>${c.label}</h4><div class="small">Ø§Ù„Ø·Ù„Ø§Ø¨: ${c.stats.count}</div><div style="font-weight:700">${c.stats.meanPercent}%</div></div>
        <div class="card"><h4>Ø§Ù„ÙˆØ³ÙŠØ·</h4><div class="small">${c.stats.median}%</div></div>
        <div class="card"><h4>Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</h4><div class="small">${c.stats.stdDev}%</div></div>
      </div>
    `;
    
    let tableHtml = `<h4 style="margin-top:14px">${c.label} â€” Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h4><div class="table-wrap"><table><thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th><th>Ø§Ù„ÙØ¦Ø©</th></tr></thead><tbody>`;
    c.rows.forEach((r, i) => {
      tableHtml += `<tr><td>${i + 1}</td><td>${escapeHtml(r.name)}</td><td>${r.grade}</td><td>${toFixedStr(r.percent, 2)}%</td><td>${r.category}</td></tr>`;
    });
    tableHtml += `</tbody></table></div>`;
    perClassDiv.innerHTML += cards + tableHtml;
  });

  // Ø§Ù„ØªÙ‚Ø±ÙŠØ±
  const reportText = `
ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ â€” ${escapeHtml(subject)}
Ø§Ù„Ù…Ø¹Ù„Ù…: ${escapeHtml(teacher)} â€” Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${escapeHtml(school)}
Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${escapeHtml(testType)} â€” Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©: ${totalGrade}

Ø§Ù„Ù…Ù„Ø®Øµ:
${processedClasses.map(pc => `
${pc.label}:
- Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: ${pc.stats.count}
- Ø§Ù„Ù…ØªÙˆØ³Ø·: ${pc.stats.meanPercent}%
- Ø§Ù„ÙˆØ³ÙŠØ·: ${pc.stats.median}%
- Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ: ${pc.stats.stdDev}%
- Ø§Ù„ØªÙˆØ²ÙŠØ¹: ${Object.entries(pc.cats).map(([k, v]) => `${k}(${v.length})`).join('ØŒ ')}
`).join('\n')}

ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:
${getPedagogicalAnalysis(processedClasses)}

ØªÙ… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯: ${new Date().toLocaleDateString('ar-EG')}
  `;
  
  document.getElementById('finalReport').innerText = reportText;

  // Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  document.getElementById('downloadPdf').onclick = () => downloadPDF();
  document.getElementById('downloadExcel').onclick = () => exportAllExcel(processedClasses);
  document.getElementById('printReport').onclick = () => window.print();
  document.getElementById('backBtn').onclick = () => {
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('inputSection').style.display = 'block';
  };
}

// ØªØ­Ù„ÙŠÙ„ ØªØ±Ø¨ÙˆÙŠ
function getPedagogicalAnalysis(processedClasses) {
  let analysis = '';
  const overallAvg = mean(processedClasses.map(pc => Number(pc.stats.meanPercent)));
  
  if (overallAvg >= 80) {
    analysis = 'â€¢ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… Ù…Ù…ØªØ§Ø² - ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¥Ø«Ø±Ø§Ø¡ ÙˆØ§Ù„ØªØ­Ø¯ÙŠ\nâ€¢ Ù…Ø³ØªÙˆÙ‰ Ø¹Ø§Ù„Ù Ù…Ù† Ø§Ù„ÙÙ‡Ù… ÙˆØ§Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨';
  } else if (overallAvg >= 70) {
    analysis = 'â€¢ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯ - ÙŠØ­ØªØ§Ø¬ Ù„ØªØ¹Ø²ÙŠØ² Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ…\nâ€¢ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©';
  } else if (overallAvg >= 60) {
    analysis = 'â€¢ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ù‚Ø¨ÙˆÙ„ - ÙŠØ­ØªØ§Ø¬ Ù„Ø¯Ø¹Ù… Ø¥Ø¶Ø§ÙÙŠ\nâ€¢ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³';
  } else {
    analysis = 'â€¢ Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙŠØ­ØªØ§Ø¬ Ù„ØªØ¯Ø®Ù„ Ø¹Ø§Ø¬Ù„\nâ€¢ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¯Ø±ÙŠØ³ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©\nâ€¢ ØªÙˆÙÙŠØ± Ø¯Ø¹Ù… ÙØ±Ø¯ÙŠ';
  }
  
  return analysis;
}

// Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ù€ PDF
function downloadPDF() {
  const elements = document.querySelectorAll('.no-print');
  elements.forEach(el => el.style.display = 'none');
