<!-- استبدل الجزء الأخير من الكود السابق بهذا الكود المبسط -->

<script>
// ... (الجزء الأول من الكود يبقى كما هو)

// تبسيط دالة التحليل الرئيسية
document.getElementById('analyzeBtn').addEventListener('click', async ()=>{
  try{
    clearMessages();
    const teacher=document.getElementById('teacherName').value||'-';
    const school=document.getElementById('schoolName').value||'-';
    const subject=document.getElementById('subject').value||'-';
    const testType=document.getElementById('testType').value||'-';
    const totalGrade=Number(document.getElementById('totalGrade').value)||100;
    const classCount=Number(classCountSelect.value);
    const classesData=[];
    
    // جمع البيانات من الفصول
    for(let i=0;i<classCount;i++){
      const cfi=classFileInputs[i];
      let json=cfi.sheetJson;
      
      if((!json||json.length===0) && cfi.pasteArea.value.trim()) {
        json=parsePasted(cfi.pasteArea.value);
      }
      
      if(!json||json.length===0) continue;
      
      const normalized=json.map((row,idx)=>{
        const name = row['اسم الطالب'] || row['name'] || row['Name'] || row['student'] || row['Student'] || Object.values(row)[0] || ('طالب'+(idx+1));
        const rawGrade = row['الدرجة'] || row['grade'] || row['Grade'] || Object.values(row)[1] || '';
        const grade = Number(rawGrade);
        
        return {
          name:String(name).trim(), 
          grade:isNaN(grade)? null: grade
        };
      }).filter(r=>r.name && r.grade !== null);
      
      if(normalized.length > 0){
        classesData.push({
          label:`الفصل ${i+1}`, 
          rows:normalized
        });
        showMessage(`تم تحميل ${normalized.length} طالب من فصل ${i+1}`, 'success');
      }
    }
    
    if(classesData.length===0){
      showMessage('لم يتم إدخال بيانات صالحة. تأكد من إدخال الأسماء والدرجات.', 'error'); 
      return;
    }
    
    // معالجة البيانات الأساسية فقط
    const processedClasses=classesData.map(c=>{
      const totalG=totalGrade;
      const grades=c.rows.map(r=>r.grade);
      const percents=grades.map(g=> (g/totalG)*100 );
      
      const meanGrade=mean(grades);
      const meanPct=mean(percents);
      const medPct=median(percents);
      const sdPct=stdPop(percents);
      const maxGrade=Math.max(...grades);
      const minGrade=Math.min(...grades);
      
      const cats={'ممتاز':[],'جيد جداً':[],'جيد':[],'مقبول':[],'ضعيف':[]};
      const rows=c.rows.map(r=>{
        const pct=(r.grade/totalG)*100; 
        const cat=classifyPercent(pct); 
        const diff=pct-meanPct; 
        const out={...r,percent:pct,category:cat,diffFromMean:diff}; 
        cats[cat].push(out); 
        return out;
      });
      
      return { 
        label:c.label, 
        rows, 
        stats:{ 
          count:rows.length, 
          meanGrade:toFixedStr(meanGrade,2), 
          meanPercent:toFixedStr(meanPct,2), 
          median:toFixedStr(medPct,2), 
          stdDev:toFixedStr(sdPct,2), 
          maxGrade, 
          minGrade
        }, 
        cats
      };
    });

    renderBasicResults({teacher,school,subject,testType,totalGrade,processedClasses});
  }catch(err){
    console.error(err);
    showMessage('خطأ أثناء التحليل: '+err.message,'error');
  }
});

// دالة عرض النتائج المبسطة
function renderBasicResults(context){
  document.getElementById('inputSection').style.display='none';
  document.getElementById('resultsSection').style.display='block';
  
  const {teacher,school,subject,testType,totalGrade,processedClasses}=context;
  const summaryArea=document.getElementById('summaryArea');
  
  summaryArea.innerHTML = `
    <div class="small">المعلم: <strong>${escapeHtml(teacher)}</strong> — المدرسة: <strong>${escapeHtml(school)}</strong> — المادة: <strong>${escapeHtml(subject)}</strong> — الاختبار: <strong>${escapeHtml(testType)}</strong> — الدرجة الكلية: <strong>${totalGrade}</strong></div>
  `;

  // إحصائيات مبسطة
  const statsHTML = processedClasses.map(c => `
    <div class="stat-card">
      <h3>${c.label}</h3>
      <div class="stat-value">${c.stats.meanPercent}%</div>
      <div class="stat-detail">${c.stats.count} طالب | الانحراف: ${c.stats.stdDev}%</div>
    </div>
  `).join('');
  
  document.getElementById('overallStats').innerHTML = statsHTML;

  // جداول الطلاب
  const perClassDiv=document.getElementById('perClassTables'); 
  perClassDiv.innerHTML='';
  
  processedClasses.forEach((c,idx)=>{
    const cards = `
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
        <div class="card"><h4>${c.label}</h4><div class="small">الطلاب: ${c.stats.count}</div><div style="font-weight:700">${c.stats.meanPercent}%</div></div>
        <div class="card"><h4>الوسيط</h4><div class="small">${c.stats.median}%</div></div>
        <div class="card"><h4>الانحراف</h4><div class="small">${c.stats.stdDev}%</div></div>
        <div class="card"><h4>أعلى درجة</h4><div class="small">${c.stats.maxGrade}</div></div>
      </div>
    `;
    
    let tableHtml=`<h4 style="margin-top:14px">${c.label} — قائمة الطلاب</h4><div class="table-wrap"><table><thead><tr><th>الرقم</th><th>الاسم</th><th>الدرجة</th><th>النسبة</th><th>الفئة</th></tr></thead><tbody>`;
    c.rows.forEach((r,i)=>{ 
      tableHtml += `<tr><td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${r.grade}</td><td>${toFixedStr(r.percent,2)}%</td><td>${r.category}</td></tr>`; 
    });
    tableHtml += `</tbody></table></div>`; 
    perClassDiv.innerHTML += cards + tableHtml;
  });

  // التقرير النهائي
  const reportText = `
تقرير التحليل التربوي — ${escapeHtml(subject)}
المعلم: ${escapeHtml(teacher)} — المدرسة: ${escapeHtml(school)}
نوع الاختبار: ${escapeHtml(testType)} — الدرجة الكلية: ${totalGrade}

الملخص العام:
- عدد الفصول المحللة: ${processedClasses.length}
${processedClasses.map(pc => `- ${pc.label}: ${pc.stats.count} طالب، المتوسط: ${pc.stats.meanPercent}%`).join('\n')}

تم إعداد التقرير بواسطة: ${escapeHtml(teacher)}
تاريخ: ${new Date().toLocaleDateString('ar-EG')}
  `;
  
  document.getElementById('finalReport').innerText = reportText;

  // إعداد الأزرار
  document.getElementById('downloadPdf').onclick = ()=> downloadPDF();
  document.getElementById('backBtn').onclick = ()=> { 
    document.getElementById('resultsSection').style.display='none'; 
    document.getElementById('inputSection').style.display='block'; 
  };
  document.getElementById('downloadExcel').onclick = ()=> exportAllExcel(processedClasses);
  document.getElementById('printReport').onclick = ()=> window.print();
}

// دوال التصدير الأساسية
function downloadPDF(){ 
  const opt={
    margin:10,
    filename:`تقرير_التحليل_${new Date().toISOString().slice(0,10)}.pdf`,
    image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
  }; 
  
  document.querySelectorAll('.no-print').forEach(el=>el.style.display='none');
  html2pdf().set(opt).from(document.querySelector('.container')).save().then(()=>{
    document.querySelectorAll('.no-print').forEach(el=>el.style.display='');
  });
}

function exportAllExcel(processedClasses){ 
  const wb=XLSX.utils.book_new(); 
  processedClasses.forEach(pc=>{ 
    const wsData=[['الرقم','الاسم','الدرجة','النسبة','الفئة']]; 
    pc.rows.forEach((r,i)=> wsData.push([i+1,r.name,r.grade,toFixedStr(r.percent,2),r.category])); 
    const ws=XLSX.utils.aoa_to_sheet(wsData); 
    XLSX.utils.book_append_sheet(wb,ws,pc.label.substring(0, 30));
  }); 
  XLSX.writeFile(wb,`النتائج_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// دوال المساعدة
function showMessage(msg,type='info'){ 
  const el=document.getElementById('message'); 
  el.innerHTML=msg; 
  el.className=`message ${type}`;
  setTimeout(()=>{ el.innerHTML=''; el.className=''; },5000);
}

function clearMessages(){ document.getElementById('message').innerHTML='' }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

// إعادة الضبط
document.getElementById('resetBtn').addEventListener('click', ()=>{ 
  if(confirm('مسح كل الحقول والنتائج؟')) location.reload(); 
});

// التهيئة الأولية
document.addEventListener('DOMContentLoaded', ()=>{ 
  buildFileInputs(); 
});
</script>
