<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø§Ù„Ø°ÙƒÙŠ - Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --bg: #f0f8ff;
    --primary: #2563eb;
    --primary-dark: #1e40af;
    --secondary: #10b981;
    --accent: #f59e0b;
    --muted: #64748b;
    --card: #ffffff;
    --border: #e2e8f0;
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --text: #1e293b;
    --text-light: #64748b;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Cairo', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    padding: 20px;
  }
  
  .container {
    max-width: 1400px;
    margin: 0 auto;
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    overflow: hidden;
  }
  
  header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 24px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  
  header::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
    opacity: 0.1;
  }
  
  header h1 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 700;
    position: relative;
  }
  
  header .sub {
    opacity: 0.9;
    margin-top: 8px;
    font-size: 1.1rem;
    position: relative;
  }
  
  .section {
    padding: 24px;
  }
  
  .section-title {
    font-size: 1.4rem;
    margin-bottom: 20px;
    color: var(--primary);
    border-bottom: 2px solid var(--border);
    padding-bottom: 10px;
    position: relative;
  }
  
  .section-title::after {
    content: "";
    position: absolute;
    bottom: -2px;
    right: 0;
    width: 80px;
    height: 2px;
    background: var(--secondary);
  }
  
  .grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--text);
  }
  
  input[type="text"],
  input[type="number"],
  select,
  textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 1rem;
    font-family: 'Cairo', sans-serif;
    transition: all 0.3s;
  }
  
  input[type="text"]:focus,
  input[type="number"]:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }
  
  button {
    padding: 12px 20px;
    border-radius: 10px;
    border: 0;
    background: var(--primary);
    color: white;
    cursor: pointer;
    font-family: 'Cairo', sans-serif;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  button:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  
  button.secondary {
    background: var(--secondary);
  }
  
  button.secondary:hover {
    background: #0da271;
  }
  
  button.danger {
    background: var(--danger);
  }
  
  button.danger:hover {
    background: #dc2626;
  }
  
  button.accent {
    background: var(--accent);
  }
  
  button.accent:hover {
    background: #d97706;
  }
  
  .small {
    font-size: 0.9rem;
    color: var(--muted);
  }
  
  .upload-box {
    border: 2px dashed #c7d2fe;
    padding: 20px;
    border-radius: 10px;
    background: #f8faff;
    text-align: center;
    transition: all 0.3s;
  }
  
  .upload-box:hover {
    border-color: var(--primary);
    background: #f0f4ff;
  }
  
  .card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
    transition: all 0.3s;
  }
  
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }
  
  .stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border-left: 4px solid var(--primary);
  }
  
  .stat-card h3 {
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 8px;
  }
  
  .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--primary);
  }
  
  .stat-detail {
    font-size: 0.85rem;
    color: var(--muted);
    margin-top: 5px;
  }
  
  .table-wrap {
    margin-top: 20px;
    overflow: auto;
    border-radius: 10px;
    border: 1px solid var(--border);
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
  }
  
  th, td {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border);
    text-align: center;
  }
  
  th {
    background: var(--primary);
    color: white;
    font-weight: 600;
  }
  
  tr:nth-child(even) {
    background: #f8fafc;
  }
  
  tr:hover {
    background: #f1f5f9;
  }
  
  .report {
    background: #f8fafc;
    padding: 20px;
    border-radius: 10px;
    border-right: 4px solid var(--secondary);
    margin-top: 20px;
    white-space: pre-line;
    line-height: 1.8;
  }
  
  .controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 20px;
  }
  
  .export {
    background: var(--secondary);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    border: 0;
    cursor: pointer;
  }
  
  .no-print {
    display: inline-block;
  }
  
  .print-only {
    display: none;
  }
  
  .charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }
  
  .chart-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
  }
  
  .chart-title {
    font-size: 1.1rem;
    margin-bottom: 15px;
    text-align: center;
    color: var(--primary);
    font-weight: 600;
  }
  
  .message {
    padding: 12px 16px;
    border-radius: 8px;
    margin: 10px 0;
    font-weight: 500;
  }
  
  .message.success {
    background: #f0fdf4;
    color: #166534;
    border: 1px solid #bbf7d0;
  }
  
  .message.error {
    background: #fef2f2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }
  
  .message.info {
    background: #eff6ff;
    color: #1e40af;
    border: 1px solid #dbeafe;
  }
  
  .correlation-result {
    background: #f0f9ff;
    padding: 20px;
    border-radius: 10px;
    margin-top: 20px;
    border-left: 4px solid var(--accent);
  }
  
  @media (max-width: 768px) {
    .grid {
      grid-template-columns: 1fr;
    }
    
    .charts-container {
      grid-template-columns: 1fr;
    }
    
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .controls {
      flex-direction: column;
    }
    
    button {
      width: 100%;
    }
  }
  
  @media print {
    .no-print {
      display: none !important;
    }
    
    .print-only {
      display: block;
    }
    
    .container {
      box-shadow: none;
      border-radius: 0;
    }
    
    .section {
      padding: 15px;
    }
    
    button {
      display: none;
    }
    
    .card, .stat-card {
      box-shadow: none;
      border: 1px solid #ddd;
    }
    
    .charts-container {
      break-inside: avoid;
    }
    
    table {
      break-inside: avoid;
    }
    
    .report {
      break-inside: avoid;
    }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØµÙˆÙ„</h1>
    <div class="sub">Ø¥Ø¹Ø¯Ø§Ø¯: <strong>Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ</strong> â€” <strong>Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø±Ø§Ø²ÙŠ</strong></div>
  </header>

  <!-- INPUT SECTION -->
  <div class="section no-print" id="inputSection">
    <h3 class="section-title">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
    <div class="grid" style="margin-top:12px">
      <div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</label>
        <input id="teacherName" type="text" value="Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ" />
      </div>
      <div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
        <input id="schoolName" type="text" value="Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø±Ø§Ø²ÙŠ" />
      </div>
      <div>
        <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
        <input id="subject" type="text" value="Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª" />
      </div>
      <div>
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
        <select id="testType">
          <option value="ØªÙƒÙˆÙŠÙ†ÙŠ">ØªÙƒÙˆÙŠÙ†ÙŠ</option>
          <option value="ØªÙ‚ÙˆÙŠÙ…ÙŠ">ØªÙ‚ÙˆÙŠÙ…ÙŠ</option>
          <option value="ØªØ´Ø®ÙŠØµÙŠ">ØªØ´Ø®ÙŠØµÙŠ</option>
          <option value="Ù…Ù‡Ø§Ø±ÙŠ">Ù…Ù‡Ø§Ø±ÙŠ</option>
          <option value="Ø´ÙÙˆÙŠ">Ø´ÙÙˆÙŠ</option>
        </select>
      </div>
      <div>
        <label>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</label>
        <input id="totalGrade" type="number" value="100" min="1" />
      </div>
      <div>
        <label>Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ Ù„Ù„ØªØ­Ù„ÙŠÙ„</label>
        <select id="classCount">
          <option value="1">ÙØµÙ„ ÙˆØ§Ø­Ø¯</option>
          <option value="2">ÙØµÙ„Ø§Ù†</option>
          <option value="3">3 ÙØµÙˆÙ„</option>
          <option value="4">4 ÙØµÙˆÙ„</option>
          <option value="5">5 ÙØµÙˆÙ„</option>
          <option value="6">6 ÙØµÙˆÙ„</option>
        </select>
      </div>
    </div>

    <div style="margin-top:20px">
      <label>Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØµÙˆÙ„</label>
      <div id="filesArea"></div>
      <div class="small" style="margin-top:8px">ÙŠÙ…ÙƒÙ† Ø±ÙØ¹ Ù…Ù„Ù Excel Ù„ÙƒÙ„ ÙØµÙ„ (Ø¹Ù…ÙˆØ¯Ø§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„: "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" Ùˆ"Ø§Ù„Ø¯Ø±Ø¬Ø©")ØŒ Ø£Ùˆ Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨ØµÙŠØºØ©: Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ø¯Ø±Ø¬Ø©,Ø¹Ù…ÙˆØ¯X,...</div>
    </div>

    <div style="margin-top:20px">
      <label>ØªØ­Ù„ÙŠÙ„ Ø§Ø±ØªØ¨Ø§Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <div class="grid">
        <div>
          <select id="correlationMode">
            <option value="">â€” Ø¨Ø¯ÙˆÙ† ØªØ­Ù„ÙŠÙ„ Ø§Ø±ØªØ¨Ø§Ø· â€”</option>
            <option value="pearson">Ø¨ÙŠØ±Ø³ÙˆÙ† (ÙƒÙ…ÙŠ Ã— ÙƒÙ…ÙŠ)</option>
            <option value="spearman">Ø³Ø¨ÙŠØ±Ù…Ø§Ù† (Ø±ØªØ¨ÙŠ/Ø¨Ø¯ÙŠÙ„)</option>
            <option value="pointbiserial">Ø¨Ø§ÙŠØ³ÙŠØ±ÙŠØ§Ù„ (ÙƒÙ…ÙŠ Ã— Ø§Ø³Ù…ÙŠ Ø«Ù†Ø§Ø¦ÙŠ)</option>
            <option value="phi">ÙØ§ÙŠ (Ø§Ø³Ù…ÙŠ Ø«Ù†Ø§Ø¦ÙŠ Ã— Ø§Ø³Ù…ÙŠ Ø«Ù†Ø§Ø¦ÙŠ)</option>
          </select>
        </div>
        <div>
          <label>Ø§Ø®ØªØ± ÙØµÙ„Ù‹Ø§ Ù„Ù„ØªØ­Ù„ÙŠÙ„ (Ø¥Ù† ÙˆÙØ¬Ø¯)</label>
          <select id="corrClassSelect"></select>
        </div>
        <div>
          <label>Ø§Ù„Ù…ØªØºÙŠØ± X</label>
          <select id="corrVarX"><option value="">â€” Ø§Ø®ØªØ± Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù â€”</option></select>
        </div>
        <div>
          <label>Ø§Ù„Ù…ØªØºÙŠØ± Y</label>
          <select id="corrVarY"><option value="">â€” Ø§Ø®ØªØ± Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù â€”</option></select>
        </div>
      </div>
      <div id="corrHint" class="small" style="margin-top:10px">Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø³ÙŠØ¹Ø±Ø¶ Ù„Ùƒ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±.</div>
    </div>

    <div style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap">
      <button id="analyzeBtn" class="secondary">ØªØ­Ù„ÙŠÙ„ ØªØ±Ø¨ÙˆÙŠ Ù…ØªÙ‚Ø¯Ù…</button>
      <button id="resetBtn" class="danger">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </div>

    <div id="message" style="margin-top:15px"></div>
  </div>

  <!-- RESULTS SECTION -->
  <div class="section" id="resultsSection" style="display:none">
    <h3 class="section-title">Ù†ØªØ§Ø¦Ø¬ ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª</h3>
    <div id="summaryArea"></div>
    
    <div class="stats-grid" id="overallStats"></div>
    
    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-title">Ù…Ù‚Ø§Ø±Ù†Ø© Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„ÙØµÙˆÙ„</div>
        <canvas id="comparisonChart"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div>
        <canvas id="distributionChart"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">Ø§Ù„ØªØµÙ†ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø§Øª</div>
        <canvas id="categoryChart"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØªØ¨Ø§ÙŠÙ† Ø¨ÙŠÙ† Ø§Ù„ÙØµÙˆÙ„</div>
        <canvas id="varianceChart"></canvas>
      </div>
    </div>
    
    <div id="perClassTables" style="margin-top:20px"></div>
    <div id="corrResult" style="margin-top:20px"></div>
    <div class="report" id="finalReport" style="margin-top:20px"></div>

    <div class="controls no-print">
      <button class="export" id="downloadPdf">ğŸ“„ ØªÙ†Ø²ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± PDF</button>
      <button class="export" id="downloadExcel">ğŸ“Š ØªÙ†Ø²ÙŠÙ„ Excel Ù…ÙØµÙÙ†ÙÙ‘Ù</button>
      <button class="export" id="printReport">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      <button class="accent" id="backBtn">â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</button>
    </div>
  </div>
</div>

<script>
// Utilities
function toFixedStr(n,d=2){return Number(n).toFixed(d)}
function mean(a){return a.reduce((s,x)=>s+x,0)/a.length}
function median(a){const s=[...a].sort((x,y)=>x-y);const m=Math.floor(s.length/2);return s.length%2? s[m] : (s[m-1]+s[m])/2}
function stdPop(a){const m=mean(a);return Math.sqrt(a.reduce((s,x)=>s+Math.pow(x-m,2),0)/a.length)}
function mode(arr) {
  const freq = {};
  let maxFreq = 0;
  let modes = [];
  
  for (const val of arr) {
    freq[val] = (freq[val] || 0) + 1;
    if (freq[val] > maxFreq) {
      maxFreq = freq[val];
      modes = [val];
    } else if (freq[val] === maxFreq) {
      modes.push(val);
    }
  }
  
  return modes.length === arr.length ? [] : modes;
}
function range(a){return Math.max(...a)-Math.min(...a)}
function coefficientOfVariation(a){const m=mean(a);return m===0?0:(stdPop(a)/m)*100}
function skewness(a){const m=mean(a);const s=stdPop(a);if(s===0)return 0;return a.reduce((sum,x)=>sum+Math.pow((x-m)/s,3),0)/a.length}
function kurtosis(a){const m=mean(a);const s=stdPop(a);if(s===0)return 0;return a.reduce((sum,x)=>sum+Math.pow((x-m)/s,4),0)/a.length-3}
function quartile(a, q) {
  const sorted = [...a].sort((x, y) => x - y);
  const pos = (sorted.length - 1) * q;
  const base = Math.floor(pos);
  const rest = pos - base;
  
  if (sorted[base + 1] !== undefined) {
    return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
  } else {
    return sorted[base];
  }
}
function rankArray(arr){const sorted=arr.map((v,i)=>({v,i})).sort((a,b)=>a.v-b.v);const ranks=[];for(let i=0;i<sorted.length;i++)ranks[sorted[i].i]=i+1;return ranks}
function pearsonCorr(x,y){if(x.length!==y.length||x.length===0) return NaN;const mx=mean(x), my=mean(y);let num=0,dx=0,dy=0;for(let i=0;i<x.length;i++){num+=(x[i]-mx)*(y[i]-my);dx+=(x[i]-mx)*(x[i]-mx);dy+=(y[i]-my)*(y[i]-my);}return num/Math.sqrt(dx*dy)}
function spearmanCorr(x,y){return pearsonCorr(rankArray(x), rankArray(y))}
function pointBiserialCorr(bin,quant){const n=bin.length;const meanAll=mean(quant);const mean1=mean(quant.filter((v,i)=>bin[i]===1));const mean0=mean(quant.filter((v,i)=>bin[i]===0));const p=bin.reduce((s,v)=>s+v,0)/n;const q=1-p;const sd=Math.sqrt(quant.reduce((s,v)=>s+Math.pow(v-meanAll,2),0)/n);return (mean1-mean0)/sd * Math.sqrt(p*q)}
function phiCoefficient(bx,by){let a=0,b=0,c=0,d=0;for(let i=0;i<bx.length;i++){if(bx[i]===1&&by[i]===1) a++; else if(bx[i]===1&&by[i]===0) b++; else if(bx[i]===0&&by[i]===1) c++; else d++;}return (a*d - b*c)/Math.sqrt((a+b)*(c+d)*(a+c)*(b+d))}
function classifyPercent(p){if(p>=90) return 'Ù…Ù…ØªØ§Ø²'; if(p>=80) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹'; if(p>=70) return 'Ø¬ÙŠØ¯'; if(p>=60) return 'Ù…Ù‚Ø¨ÙˆÙ„'; return 'Ø¶Ø¹ÙŠÙ'}

// UI for file inputs
const filesArea = document.getElementById('filesArea');
const classCountSelect = document.getElementById('classCount');
const corrClassSelect = document.getElementById('corrClassSelect');
const corrVarX = document.getElementById('corrVarX');
const corrVarY = document.getElementById('corrVarY');
let classFileInputs = []; // {fileInput,pasteArea,headers,sheetJson,classIndex}

function buildFileInputs(){
  filesArea.innerHTML=''; classFileInputs=[]; const count=Number(classCountSelect.value);
  for(let i=1;i<=count;i++){
    const div=document.createElement('div'); div.style.marginTop='12px';
    div.innerHTML=`
      <div style="display:flex;gap:10px;align-items:center">
        <strong>ÙØµÙ„ ${i}</strong>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
        <div class="upload-box">
          <input type="file" accept=".xlsx,.xls" class="classFileInput" data-class="${i}">
          <div class="small">Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„</div>
        </div>
        <div>
          <textarea class="pasteArea" data-class-area="${i}" rows="5" placeholder="Ø£Ùˆ Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ (Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ø¯Ø±Ø¬Ø©,Ø¹Ù…ÙˆØ¯X,...)"></textarea>
        </div>
      </div>
    `;
    filesArea.appendChild(div);
    const fileInput = div.querySelector('.classFileInput');
    const pasteArea = div.querySelector('.pasteArea');
    classFileInputs.push({fileInput,pasteArea,headers:[],sheetJson:null,classIndex:i});
    fileInput.addEventListener('change', onClassFileChange);
  }
  buildCorrClassOptions();
}
function buildCorrClassOptions(){corrClassSelect.innerHTML='';const count=Number(classCountSelect.value);for(let i=1;i<=count;i++){const o=document.createElement('option');o.value=i;o.innerText=`ÙØµÙ„ ${i}`;corrClassSelect.appendChild(o);}corrClassSelect.dispatchEvent(new Event('change'))}
classCountSelect.addEventListener('change', buildFileInputs);
document.addEventListener('DOMContentLoaded', buildFileInputs);

// read file
async function onClassFileChange(e){
  const input=e.target; const idx=classFileInputs.findIndex(c=>c.fileInput===input); if(idx<0) return;
  const file=input.files[0]; if(!file) return;
  try{
    const arrayBuffer=await file.arrayBuffer();
    const workbook=XLSX.read(arrayBuffer,{type:'array'});
    const sheetName=workbook.SheetNames[0];
    const sheet=workbook.Sheets[sheetName];
    const json=XLSX.utils.sheet_to_json(sheet,{defval:''});
    classFileInputs[idx].sheetJson=json;
    classFileInputs[idx].headers=getHeadersFromJson(json);
    showMessage(`ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù ÙØµÙ„ ${classFileInputs[idx].classIndex} â€” ${json.length} ØµÙÙˆÙ.`, 'success');
    populateCorrVarsFromFiles();
  }catch(err){console.error(err);showMessage('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚.', 'error')}
}
function getHeadersFromJson(json){if(!json||json.length===0) return []; return Object.keys(json[0])}

// main analyze
document.getElementById('analyzeBtn').addEventListener('click', async ()=>{
  try{
    clearMessages();
    const teacher=document.getElementById('teacherName').value||'-';
    const school=document.getElementById('schoolName').value||'-';
    const subject=document.getElementById('subject').value||'-';
    const testType=document.getElementById('testType').value||'-';
    const totalGrade=Number(document.getElementById('totalGrade').value)||100;
    const classCount=Number(classCountSelect.value);
    const classesData=[];
    for(let i=0;i<classCount;i++){
      const cfi=classFileInputs[i];
      let json=cfi.sheetJson;
      if((!json||json.length===0) && cfi.pasteArea.value.trim()) json=parsePasted(cfi.pasteArea.value);
      if(!json||json.length===0) continue;
      const normalized=json.map((row,idx)=>{
        const name = row['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'] || row['name'] || row['Name'] || row['student'] || row['Student'] || Object.values(row)[0] || ('Ø·Ø§Ù„Ø¨'+(idx+1));
        const rawGrade = row['Ø§Ù„Ø¯Ø±Ø¬Ø©'] || row['grade'] || row['Grade'] || Object.values(row)[1] || '';
        const grade = Number(rawGrade);
        const extra={};
        for(const k of Object.keys(row)){
          if(['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨','name','Name','student','Student','Ø§Ù„Ø¯Ø±Ø¬Ø©','grade','Grade'].includes(k)) continue;
          const v=row[k];
          if(v===null||v===undefined||String(v).trim()==='') continue;
          const num=Number(v);
          extra[k]=isNaN(num)? String(v) : num;
        }
        return {name:String(name).trim(), grade:isNaN(grade)? null: grade, extra};
      }).filter(r=>r.name);
      classesData.push({label:`Ø§Ù„ÙØµÙ„ ${i+1}`, rows:normalized});
    }
    if(classesData.length===0){showMessage('Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©. Ø§Ø±ÙØ¹ Ù…Ù„ÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'error'); return}
    const processedClasses=classesData.map(c=>{
      const totalG=totalGrade;
      const valid=c.rows.filter(r=>r.grade!==null && !isNaN(r.grade));
      const limited=valid.slice(0,50);
      const grades=limited.map(r=>r.grade);
      const percents=grades.map(g=> (g/totalG)*100 );
      const meanGrade=grades.length? mean(grades):0;
      const meanPct=percents.length? mean(percents):0;
      const medPct=percents.length? median(percents):0;
      const sdPct=percents.length? stdPop(percents):0;
      const maxGrade=grades.length? Math.max(...grades):0;
      const minGrade=grades.length? Math.min(...grades):0;
      const modeGrade = grades.length ? mode(grades) : [];
      const rangeGrade = grades.length ? range(grades) : 0;
      const cv = grades.length ? coefficientOfVariation(grades) : 0;
      const skew = grades.length ? skewness(grades) : 0;
      const kurt = grades.length ? kurtosis(grades) : 0;
      const q1 = grades.length ? quartile(grades, 0.25) : 0;
      const q3 = grades.length ? quartile(grades, 0.75) : 0;
      const iqr = grades.length ? q3 - q1 : 0;
      
      const cats={'Ù…Ù…ØªØ§Ø²':[],'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹':[],'Ø¬ÙŠØ¯':[],'Ù…Ù‚Ø¨ÙˆÙ„':[],'Ø¶Ø¹ÙŠÙ':[]};
      const rows=limited.map(r=>{const pct=(r.grade/totalG)*100; const cat=classifyPercent(pct); const diff=pct-meanPct; const out={...r,percent:pct,category:cat,diffFromMean:diff}; cats[cat].push(out); return out;});
      const extras={};
      rows.forEach(r=>{ for(const k in r.extra){ if(typeof r.extra[k]==='number'){ if(!extras[k]) extras[k]=[]; extras[k].push(r.extra[k]); } else { if(!extras[k]) extras[k]=[]; extras[k].push(r.extra[k]); } } });
      return { 
        label:c.label, 
        rows, 
        stats:{ 
          count:rows.length, 
          meanGrade:toFixedStr(meanGrade,2), 
          meanPercent:toFixedStr(meanPct,2), 
          median:toFixedStr(medPct,2), 
          stdDev:toFixedStr(sdPct,2), 
          maxGrade, 
          minGrade, 
          maxPercent:toFixedStr(Math.max(...(percents||[0])),2), 
          minPercent:toFixedStr(Math.min(...(percents||[0])),2),
          mode: modeGrade.length > 0 ? modeGrade.map(m => toFixedStr(m, 2)).join(', ') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯',
          range: toFixedStr(rangeGrade, 2),
          coefficientOfVariation: toFixedStr(cv, 2),
          skewness: toFixedStr(skew, 3),
          kurtosis: toFixedStr(kurt, 3),
          q1: toFixedStr(q1, 2),
          q3: toFixedStr(q3, 2),
          iqr: toFixedStr(iqr, 2)
        }, 
        cats, 
        extras 
      };
    });

    renderResults({teacher,school,subject,testType,totalGrade,processedClasses});
  }catch(err){console.error(err);showMessage('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„: '+err.message,'error')}
});
